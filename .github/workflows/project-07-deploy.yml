name: Project 07 - Automated Receipt Processor

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options: ['plan', 'apply', 'destroy']
        default: 'plan'

env:
  AWS_REGION: ap-south-1
  PROJECT_NAME: 07-automated-receipt-processor-ci
  S3_BUCKET_NAME: 07-receipt-processor-aws-portfolio-ci-${{ github.run_number }}

jobs:
  build-lambda:
    name: Build Lambda Package
    runs-on: ubuntu-latest
    if: inputs.action != 'destroy'
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install Lambda Dependencies
        working-directory: 07-automated-receipt-processor/lambda
        run: |
          echo "ðŸ“¦ Installing Lambda dependencies..."
          pip install -r requirements.txt -t . || echo "No requirements.txt found"
      
      - name: Package Lambda Function
        working-directory: 07-automated-receipt-processor/lambda
        run: |
          echo "ðŸ“¦ Creating Lambda deployment package..."
          zip -r lambda-package.zip . -x "*.git*" "*.md" "*.txt" "__pycache__/*"
          ls -la lambda-package.zip
          echo "âœ… Lambda package created successfully"
      
      - name: Upload Lambda Package
        uses: actions/upload-artifact@v4
        with:
          name: lambda-package
          path: 07-automated-receipt-processor/lambda/lambda-package.zip
          retention-days: 1

  terraform-infrastructure:
    name: Terraform Infrastructure
    runs-on: ubuntu-latest
    needs: [build-lambda]
    if: always() && (needs.build-lambda.result == 'success' || inputs.action == 'destroy')
    outputs:
      lambda_function_url: ${{ steps.outputs.outputs.lambda_function_url }}
      lambda_function_name: ${{ steps.outputs.outputs.lambda_function_name }}
      s3_bucket_name: ${{ steps.outputs.outputs.s3_bucket_name }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Download Lambda Package
        if: inputs.action != 'destroy'
        uses: actions/download-artifact@v4
        with:
          name: lambda-package
          path: 07-automated-receipt-processor/infrastructure/
      
      - name: Create Dummy Lambda Package for Destroy
        if: inputs.action == 'destroy'
        working-directory: 07-automated-receipt-processor/infrastructure
        run: |
          echo "Creating dummy lambda package for destroy operation..."
          echo 'def lambda_handler(event, context): return {}' > lambda_function.py
          zip lambda-package.zip lambda_function.py
          rm lambda_function.py
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
          terraform_wrapper: false
      
      - name: Terraform Init
        working-directory: 07-automated-receipt-processor/infrastructure
        run: |
          echo "ðŸ”§ Initializing Terraform..."
          terraform init
      
      - name: Terraform Validate
        working-directory: 07-automated-receipt-processor/infrastructure
        run: |
          echo "âœ… Validating Terraform configuration..."
          terraform validate
      
      - name: Terraform Plan
        if: inputs.action == 'plan' || inputs.action == 'apply'
        working-directory: 07-automated-receipt-processor/infrastructure
        run: |
          echo "ðŸ“‹ Planning Terraform deployment..."
          terraform plan \
            -var="environment=ci" \
            -var="lambda_zip_path=lambda-package.zip" \
            -var="project_name=${{ env.PROJECT_NAME }}" \
            -var="aws_region=${{ env.AWS_REGION }}" \
            -var="s3_bucket_name=${{ env.S3_BUCKET_NAME }}"
      
      - name: Terraform Apply
        if: inputs.action == 'apply'
        working-directory: 07-automated-receipt-processor/infrastructure
        run: |
          echo "ðŸš€ Applying Terraform configuration..."
          terraform apply -auto-approve \
            -var="environment=ci" \
            -var="lambda_zip_path=lambda-package.zip" \
            -var="project_name=${{ env.PROJECT_NAME }}" \
            -var="aws_region=${{ env.AWS_REGION }}" \
            -var="s3_bucket_name=${{ env.S3_BUCKET_NAME }}"
      
      - name: Terraform Destroy
        if: inputs.action == 'destroy'
        working-directory: 07-automated-receipt-processor/infrastructure
        run: |
          echo "ðŸ—‘ï¸ Destroying Terraform resources..."
          terraform destroy -auto-approve \
            -var="environment=ci" \
            -var="lambda_zip_path=lambda-package.zip" \
            -var="project_name=${{ env.PROJECT_NAME }}" \
            -var="aws_region=${{ env.AWS_REGION }}" \
            -var="s3_bucket_name=${{ env.S3_BUCKET_NAME }}"
      
      - name: Capture Terraform Outputs
        id: outputs
        if: inputs.action == 'apply'
        working-directory: 07-automated-receipt-processor/infrastructure
        run: |
          echo "ðŸ“‹ Capturing Terraform outputs..."
          echo "lambda_function_url=$(terraform output -raw lambda_function_url)" >> $GITHUB_OUTPUT
          echo "lambda_function_name=$(terraform output -raw lambda_function_name)" >> $GITHUB_OUTPUT
          echo "s3_bucket_name=$(terraform output -raw s3_bucket_name)" >> $GITHUB_OUTPUT
          terraform output -json | jq '.'